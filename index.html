<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Mapa Leaflet - Transmisi칩n, Subestaciones y Sismos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-search@2.9.8/dist/leaflet-search.min.css">
<style>
  html, body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial }
  #map { height:100vh; width:100vw }
  .topbar {
    position: absolute; left:10px; top:10px; z-index:1000; background:rgba(255,255,255,0.95);
    padding:8px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15);
    display:flex; gap:8px; align-items:center
  }
  .topbar input, .topbar select, .topbar button { padding:6px 8px; border:1px solid #ddd; border-radius:6px; min-width:150px }
  .topbar button { cursor:pointer; background:#fff }
  .credits { position:absolute; left:10px; bottom:10px; z-index:1000; background:rgba(255,255,255,0.9); padding:6px 8px; font-size:12px }
  .leaflet-control-layers { max-height: 240px; overflow-y: auto; font-size: 13px; }
</style>
</head>
<body>
<div id="map"></div>

<div class="topbar">
  <input id="search" placeholder="Buscar lugar (ej. Plaza de Armas)" aria-label="Buscar lugar" />
  <button id="btnSearch">Buscar</button>
  <button id="btnLocate">Mi ubicaci칩n</button>
  <select id="basemap">
    <option value="osm">OpenStreetMap</option>
    <option value="topo">OpenTopoMap</option>
  </select>
  <label>
    <input type="checkbox" id="toggleSismos" /> 칔ltimos 5 sismos (Chile)
  </label>
</div>

<div class="credits">Mapa centrado en Santiago, Chile. Coordenadas: -33.4489, -70.6693</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-search@2.9.8/dist/leaflet-search.min.js"></script>

<script>
const santiago = {lat: -33.4489, lng: -70.6693};
const map = L.map('map', {center:[santiago.lat, santiago.lng], zoom:6});

// --- Capas base ---
const tileOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'춸 OpenStreetMap contributors'});
const tileTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {maxZoom:17, attribution:'춸 OpenTopoMap (CC-BY-SA)'});
tileOSM.addTo(map);
const baseLayers = {"OpenStreetMap": tileOSM, "OpenTopoMap": tileTopo};

// --- Capas GeoJSON de l칤neas y subestaciones ---
const capasURLs = {
  "L칤nea 1":"https://raw.githubusercontent.com/transelectuc25-uc/plataformagis/main/Linea_Transmision1.geojson",
  "L칤nea 2":"https://raw.githubusercontent.com/transelectuc25-uc/plataformagis/main/Linea_Transmision2.geojson",
  "L칤nea 3":"https://raw.githubusercontent.com/transelectuc25-uc/plataformagis/main/Linea_Transmision3.geojson",
  "L칤nea 4":"https://raw.githubusercontent.com/transelectuc25-uc/plataformagis/main/Linea_Transmision4.geojson",
  "Subestaciones 1":"https://raw.githubusercontent.com/transelectuc25-uc/plataformagis/main/Subestaciones_1.geojson",
  "Subestaciones 2":"https://raw.githubusercontent.com/transelectuc25-uc/plataformagis/main/Subestaciones_2.geojson",
  "Subestaciones 3":"https://raw.githubusercontent.com/transelectuc25-uc/plataformagis/main/Subestaciones_3.geojson",
  "Subestaciones 4":"https://raw.githubusercontent.com/transelectuc25-uc/plataformagis/main/Subestaciones_4.geojson"
};

const estilos = {
  "L칤nea 1": { color: "#ff0000", weight: 3 },
  "L칤nea 2": { color: "#00ff00", weight: 3 },
  "L칤nea 3": { color: "#00b3ff", weight: 3 },
  "L칤nea 4": { color: "#ff8c00", weight: 3 },
  "Subestaciones 1": { color: "#800080", radius:6, fillOpacity:0.8 },
  "Subestaciones 2": { color: "#008000", radius:6, fillOpacity:0.8 },
  "Subestaciones 3": { color: "#ff1493", radius:6, fillOpacity:0.8 },
  "Subestaciones 4": { color: "#0000ff", radius:6, fillOpacity:0.8 }
};

const overlays = {};
const lineasBusqueda = [];
const bounds = [];

function popupHTML(feature){
  let html = "";
  for(const [k,v] of Object.entries(feature.properties)) html+=`<b>${k}:</b> ${v}<br>`;
  return html||"Sin atributos";
}

const controlCapas = L.control.layers(baseLayers, overlays, {collapsed:true}).addTo(map);

// --- Cargar capas ---
async function cargarCapas(){
  for(const [nombre,url] of Object.entries(capasURLs)){
    try{
      const resp = await fetch(url);
      const data = await resp.json();
      const tipo = data.features[0]?.geometry?.type || "";
      let capa;
      if(tipo.includes("Point")){
        capa = L.geoJSON(data,{pointToLayer:(f,latlng)=>L.circleMarker(latlng,estilos[nombre]), onEachFeature:(f,l)=>l.bindPopup(popupHTML(f))});
      } else {
        capa = L.geoJSON(data,{style:estilos[nombre], onEachFeature:(f,l)=>{
          l.bindPopup(popupHTML(f));
          if(nombre.startsWith("L칤nea") && f.properties?.ID_LIN_TRA) lineasBusqueda.push({name:f.properties.ID_LIN_TRA, layer:l});
        }});
      }
      overlays[nombre] = capa;
      controlCapas.addOverlay(capa,nombre);
      bounds.push(capa.getBounds());
    }catch(e){ console.error("Error cargando",nombre,e); }
  }

  const totalBounds = bounds.reduce((acc,b)=>acc.extend(b), L.latLngBounds([]));
  if(totalBounds.isValid()) map.fitBounds(totalBounds);

  // --- Buscador de l칤neas ---
  const buscador = new L.Control.Search({
    layer: L.layerGroup(lineasBusqueda.map(f=>f.layer)),
    propertyName:"name",
    marker:false,
    position:"topright",
    textPlaceholder:"Buscar ID_LIN_TRA..."
  });

  buscador.on("search:locationfound", e=>{
    e.layer.setStyle({color:"yellow", weight:5});
    setTimeout(()=>e.layer.setStyle({color:"#ff0000", weight:3}),2000);
  });

  map.addControl(buscador);
}
cargarCapas();

// --- Geolocalizaci칩n ---
document.getElementById('btnLocate').addEventListener('click', ()=>{
  if(!navigator.geolocation) return alert('Geolocalizaci칩n no soportada.');
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    L.marker([lat,lng]).addTo(map).bindPopup('Tu ubicaci칩n').openPopup();
    map.setView([lat,lng],15);
  });
});

// --- Cambiar mapa base ---
const basemapEl = document.getElementById('basemap');
basemapEl.addEventListener('change', e=>{
  if(e.target.value==='osm'){ tileTopo.remove(); tileOSM.addTo(map); }
  else{ tileOSM.remove(); tileTopo.addTo(map); }
});

// --- B칰squeda por lugar ---
async function geocode(q){
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q+', Santiago, Chile')}`;
  try{ const res=await fetch(url); const json=await res.json(); return json; } catch(e){ console.error(e); return []; }
}
document.getElementById('btnSearch').addEventListener('click', async ()=>{
  const q=document.getElementById('search').value.trim();
  if(!q) return alert('Escribe algo para buscar.');
  const results = await geocode(q);
  if(!results || results.length===0) return alert('No se encontraron resultados.');
  const r=results[0];
  const lat=parseFloat(r.lat), lon=parseFloat(r.lon);
  L.marker([lat,lon]).addTo(map).bindPopup(`<strong>${r.display_name}</strong>`).openPopup();
  map.setView([lat,lon],15);
});
document.getElementById('search').addEventListener('keydown', ev=>{ if(ev.key==='Enter') document.getElementById('btnSearch').click(); });

// --- 칔ltimos 5 sismos ---
let sismoLayer = L.layerGroup();
async function cargarSismos(){
  const url = "https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&starttime="+new Date(Date.now()-7*24*3600*1000).toISOString()+"&minlatitude=-56&maxlatitude=-17&minlongitude=-76&maxlongitude=-66&limit=5&orderby=time";
  try{
    const res = await fetch(url);
    const data = await res.json();
    sismoLayer.clearLayers();
    data.features.forEach(f=>{
      const coords = f.geometry.coordinates;
      const props = f.properties;
      const lat = coords[1], lon = coords[0], depth = coords[2];
      const mag = props.mag;
      const time = new Date(props.time).toLocaleString();
      const popup = `<strong>Sismo</strong><br>Lat:${lat.toFixed(2)}<br>Lon:${lon.toFixed(2)}<br>Profundidad:${depth} km<br>Magnitud:${mag}<br>Hora:${time}`;
      L.marker([lat,lon]).addTo(sismoLayer).bindPopup(popup);
    });
  }catch(e){ console.error("Error al cargar sismos:",e); }
}
document.getElementById('toggleSismos').addEventListener('change', async ev=>{
  if(ev.target.checked){ await cargarSismos(); sismoLayer.addTo(map); } else{ map.removeLayer(sismoLayer); }
});

// --- Clic para coordenadas y viento ---
const API_KEY = '2c8d387be912dc819184ef5082f345f1';
let clickMarker = null;
async function getWindData(lat,lng){
  const apiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${API_KEY}&units=metric`;
  try{
    const resp = await fetch(apiUrl);
    if(!resp.ok){ const errData=await resp.json(); return `<b style="color:red;">Error:</b> ${errData.message||'No se pudieron obtener datos.'}`; }
    const data = await resp.json();
    const windSpeed = data.wind?.speed?.toFixed(2)??"N/D";
    const windDeg = data.wind?.deg??"N/D";
    return `<hr><b>Viento estimado:</b><br>Velocidad: ${windSpeed} m/s<br>Direcci칩n: ${windDeg}춿`;
  }catch(e){ console.error("Error viento:",e); return '<b style="color:red;">Error:</b> Problema de conexi칩n.'; }
}
map.on('click', async e=>{
  const lat = e.latlng.lat.toFixed(4);
  const lng = e.latlng.lng.toFixed(4);
  const coordsContent = `<b>Coordenadas:</b><br>Latitud: ${lat}<br>Longitud: ${lng}`;
  let popupContent = coordsContent+'<br>Cargando datos del viento... 游눧';
  if(clickMarker){ clickMarker.setLatLng(e.latlng); clickMarker.setPopupContent(popupContent); }
  else{ clickMarker = L.marker(e.latlng).addTo(map).bindPopup(popupContent); }
  clickMarker.openPopup();
  const windDataHtml = await getWindData(e.latlng.lat,e.latlng.lng);
  clickMarker.setPopupContent(coordsContent+windDataHtml);
});

console.log('Mapa cargado. Todas las funciones integradas.');
</script>
</body>
</html>
